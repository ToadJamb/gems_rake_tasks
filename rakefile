# frozen_string_literal: true

require 'cane'
require 'gems'
require 'travis/yaml' if RUBY_VERSION.match(/\d+/).to_s.to_i > 1
require 'wwtd/tasks'

require_relative 'lib/rake_tasks'
[
  'cane',
  'doc',
  'gem',
  'rdoc',
  'spec',
  'test',
  'checksum',
  'console',
  'travis_ci_lint',
  'release',
].each do |task|
  require_relative File.join('lib/rake_tasks/tasks', task)
end

$VERBOSE = true

reqs = []
reqs << :cane
reqs << 'travis_ci:lint' if Kernel.const_defined?('Travis')

specs = [
  :spec,
  'test:unit',
]

local = [
  'wwtd:parallel',
]

Rake::Task['release'].enhance do |task|
  puts `git rm gemfiles/*.lock`

  Rake::Task[:default].invoke

  `git add gemfiles`
  `git add checksum`
  `git add Gemfile`
  `git add Gemfile.lock`
  `git add *.gemspec`

  puts `git commit -m "#{RakeTasks::Gem.version}"`
  puts `git tag v#{RakeTasks::Gem.version_number}`
end

RakeTasks.build_default_tasks reqs, specs, local, !ENV['CI'].to_s.strip.empty?
